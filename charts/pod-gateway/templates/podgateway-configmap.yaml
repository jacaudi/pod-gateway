{{- include "bjw-s.common.loader.init" . -}}
{{- range $namespace := append .Values.routed_namespaces .Release.Namespace }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pod-gateway.configmap" $ | quote }}
  namespace: {{ $namespace }}
  labels:
    {{- include "bjw-s.common.lib.metadata.allLabels" $ | nindent 4 }}
    {{- with $.Values.configmap.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- with $.Values.configmap.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
data:
  settings.sh: |
    #!/bin/sh
    # Generated by {{ include "bjw-s.common.lib.chart.names.fullname" $ }}
    {{- range $key, $value := $.Values.settings }}
    {{ $key }}={{ $value | quote }}
    {{- end }}
  nat.conf: |
    # Generated by {{ include "bjw-s.common.lib.chart.names.fullname" $ }}
    {{- range $entry := $.Values.publicPorts }}
    {{ $entry.hostname | required "Missing hostname" }} {{ $entry.IP | required "Missing IP" }}
      {{- range $index, $port := $entry.ports -}}
        {{- if eq $index 0 -}}
          {{- print " " -}}
        {{- else -}}
          {{- print "," -}}
        {{- end -}}
        {{- $port.type | required "Missing port type" }}:{{ $port.port | required "Missing port number" -}}
      {{- end }}
    {{- end }}
  nat6.conf: |
    # Generated by {{ include "bjw-s.common.lib.chart.names.fullname" $ }}
    {{- range $entry := $.Values.publicPortsV6 }}
    {{ $entry.hostname | required "Missing hostname" }} {{ $entry.IP | required "Missing IP" }}
      {{- range $index, $port := $entry.ports -}}
        {{- if eq $index 0 -}}
          {{- print " " -}}
        {{- else -}}
          {{- print "," -}}
        {{- end -}}
        {{- $port.type | required "Missing port type" }}:{{ $port.port | required "Missing port number" -}}
      {{- end }}
    {{- end }}
  # Extra user-defined files
  {{- with $.Values.extraFiles }}
  {{- range $filename, $content := . }}
  {{ $filename }}: |-
    {{ $content | nindent 4 }}
  {{- end }}
  {{- end }}
{{- end -}}